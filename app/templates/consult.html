{% extends "base.html" %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-gray-900">Formulir Konsultasi</h2>
            <p class="mt-2 text-gray-600">Isi data dan gejala yang terlihat pada tanaman tomat</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-primary px-6 py-4">
                <h3 class="text-white font-medium">Data Diagnosa</h3>
            </div>

            <form action="/consult" method="post" class="p-6">
                <!-- Personal Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nama (Opsional)</label>
                        <input type="text" name="name" id="name"
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary shadow-sm"
                            placeholder="Nama pemilik">
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Umur Tanaman</label>
                        <input type="text" name="age" id="age"
                            class="w-full rounded-lg border-gray-300 focus:border-primary focus:ring-primary shadow-sm"
                            placeholder="Contoh: 3 bulan">
                    </div>
                </div>

                <hr class="border-gray-200 mb-6">

                <!-- Wizard Container -->
                <div x-data="consultationWizard()" class="min-h-[400px]">
                    <!-- Step Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2 text-sm">
                            <span class="font-medium text-primary"
                                x-text="step === 1 ? 'Langkah 1: Pilih Area' : 'Langkah 2: Identifikasi Gejala'"></span>
                            <span class="text-gray-500" x-text="step === 1 ? '1/2' : progress + '%'"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-500"
                                :style="'width: ' + (step === 1 ? '50%' : progress + '%')"></div>
                        </div>
                    </div>

                    <!-- STEP 1: Category Selection -->
                    <div x-show="step === 1">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Di bagian mana masalah terlihat?</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                            <template x-for="category in categories" :key="category">
                                <label class="cursor-pointer">
                                    <input type="checkbox" :value="category" x-model="selectedCategories"
                                        class="peer sr-only">
                                    <div
                                        class="p-4 rounded-lg border-2 border-gray-200 hover:border-primary peer-checked:border-primary peer-checked:bg-red-50 transition-all text-center relative">
                                        <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                            <svg class="w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl mb-2" x-text="getCategoryIcon(category)"></div>
                                        <span class="text-sm font-medium text-gray-700 peer-checked:text-primary"
                                            x-text="category"></span>
                                    </div>
                                </label>
                            </template>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" @click="startDiagnosis()" :disabled="selectedCategories.length === 0"
                                class="disabled:opacity-50 disabled:cursor-not-allowed bg-primary hover:bg-secondary text-white py-2 px-6 rounded-lg font-medium transition-colors">
                                Lanjut
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Sequential Questions -->
                    <div x-show="step === 2">
                        <div x-show="currentQuestion"
                            class="bg-white border border-gray-200 rounded-lg p-6 mb-6 text-center">
                            <span class="inline-block px-3 py-1 bg-gray-100 text-gray-600 rounded text-xs mb-4"
                                x-text="currentQuestion?.category + ' (' + currentQuestion?.code + ')' "></span>
                            <h3 class="text-xl font-semibold text-gray-900 mb-4" x-text="currentQuestion?.name"></h3>
                            <p class="text-gray-500 mb-6 text-sm">Seberapa yakin Anda melihat gejala ini?</p>

                            <div class="flex flex-wrap justify-center gap-3">
                                <template x-for="opt in options" :key="opt.val">
                                    <button type="button" 
                                        @click="answer(opt.val, $event)"
                                        class="confidence-box px-5 py-3 rounded-lg border-2 text-sm flex flex-col items-center min-w-[90px] relative font-medium"
                                        :class="hasAnswered(currentQuestion?.code) === opt.val ? 
                                            'selected border-primary bg-red-100 text-primary shadow-lg ring-2 ring-primary ring-opacity-50' : 
                                            'border-gray-200 hover:border-gray-300 text-gray-600 hover:bg-gray-50'">
                                        <!-- Checkmark indicator -->
                                        <div x-show="hasAnswered(currentQuestion?.code) === opt.val"
                                            x-transition:enter="transition ease-out duration-300"
                                            x-transition:enter-start="opacity-0 scale-0"
                                            x-transition:enter-end="opacity-100 scale-100"
                                            class="absolute -top-2 -right-2 w-7 h-7 bg-primary rounded-full flex items-center justify-center shadow-lg z-10">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <span class="text-xl mb-1 relative z-10" x-text="opt.emoji"></span>
                                        <span class="font-semibold relative z-10" x-text="opt.label"></span>
                                        <span class="text-xs mt-1 opacity-75 relative z-10" x-text="opt.percent"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <template x-for="(conf, code) in answers" :key="code">
                            <input type="hidden" :name="'symptoms[' + code + ']'" :value="conf">
                        </template>

                        <div class="flex justify-between items-center">
                            <button type="button" @click="prevQuestion()"
                                class="text-gray-600 hover:text-primary font-medium px-4 py-2 rounded-lg hover:bg-gray-50 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Sebelumnya
                            </button>

                            <div class="text-sm text-gray-500">
                                <span x-text="currentIndex + 1"></span> / <span
                                    x-text="filteredSymptoms.length"></span>
                            </div>

                            <div class="flex items-center gap-2">
                                <div x-show="!isCurrentQuestionAnswered()" 
                                    class="text-sm text-gray-500 italic mr-4">
                                    Pilih tingkat keyakinan terlebih dahulu
                                </div>
                                
                                <button x-show="currentIndex === filteredSymptoms.length - 1 && isCurrentQuestionAnswered()" 
                                    type="submit"
                                    class="bg-primary hover:bg-secondary text-white py-2 px-6 rounded-lg font-medium transition-colors">
                                    Lihat Hasil
                                </button>

                                <button x-show="currentIndex < filteredSymptoms.length - 1 && isCurrentQuestionAnswered()" 
                                    type="button"
                                    @click="nextQuestion()"
                                    :disabled="!isCurrentQuestionAnswered()"
                                    class="bg-gray-800 hover:bg-gray-900 text-white py-2 px-6 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    Selanjutnya
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    const allSymptoms = {{ symptoms | tojson }};

                    function consultationWizard() {
                        return {
                            step: 1,
                            categories: ['Daun', 'Batang', 'Buah', 'Bunga', 'Akar'],
                            selectedCategories: [],
                            filteredSymptoms: [],
                            currentIndex: 0,
                            answers: {},

                            get currentQuestion() {
                                return this.filteredSymptoms[this.currentIndex];
                            },

                            get progress() {
                                if (this.filteredSymptoms.length === 0) return 0;
                                return Math.round(((this.currentIndex + 1) / this.filteredSymptoms.length) * 100);
                            },

                            options: [
                                { val: 0.0, label: 'Tidak', emoji: 'âŒ', percent: '0%' },
                                { val: 0.2, label: 'Ragu', emoji: 'ðŸ¤”', percent: '20%' },
                                { val: 0.6, label: 'Mungkin', emoji: 'ðŸ‘€', percent: '60%' },
                                { val: 0.8, label: 'Yakin', emoji: 'âœ…', percent: '80%' },
                                { val: 1.0, label: 'Sangat', emoji: 'ðŸ’¯', percent: '100%' }
                            ],

                            getCategoryIcon(cat) {
                                const icons = {
                                    'Daun': 'ðŸŒ¿',
                                    'Batang': 'ðŸªµ',
                                    'Buah': 'ðŸ…',
                                    'Bunga': 'ðŸŒ¸',
                                    'Akar': 'ðŸª±'
                                };
                                return icons[cat] || 'ðŸŒ±';
                            },

                            startDiagnosis() {
                                if (this.selectedCategories.length === 0) return;
                                this.filteredSymptoms = allSymptoms.filter(s =>
                                    this.selectedCategories.includes(s.category) || !s.category
                                );
                                if (this.filteredSymptoms.length === 0) {
                                    alert("Tidak ada gejala ditemukan untuk kategori ini.");
                                    return;
                                }
                                this.step = 2;
                                this.currentIndex = 0;
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            },

                            answer(confidence, event) {
                                const code = this.currentQuestion.code;
                                this.answers[code] = confidence;
                                
                                // Add ripple effect
                                if (event && event.target) {
                                    const button = event.target.closest('button');
                                    if (button) {
                                        button.classList.add('clicked');
                                        setTimeout(() => {
                                            button.classList.remove('clicked');
                                        }, 600);
                                    }
                                }
                            },

                            hasAnswered(code) {
                                return this.answers[code] !== undefined && this.answers[code] !== null;
                            },
                            
                            isCurrentQuestionAnswered() {
                                if (!this.currentQuestion) return false;
                                return this.hasAnswered(this.currentQuestion.code);
                            },

                            nextQuestion() {
                                if (this.currentIndex < this.filteredSymptoms.length - 1) {
                                    this.currentIndex++;
                                }
                            },

                            prevQuestion() {
                                if (this.currentIndex > 0) {
                                    this.currentIndex--;
                                } else {
                                    this.step = 1;
                                }
                            }
                        }
                    }
                </script>
            </form>
        </div>
    </div>
</div>
{% endblock %}
