{% extends "base.html" %}

{% block content %}
<div class="bg-slate-50 min-h-screen py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-slate-900">Formulir Konsultasi</h2>
            <p class="mt-2 text-slate-600">Isi data dan gejala yang terlihat pada tanaman tomat Anda.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl shadow-slate-200 overflow-hidden border border-slate-100">
            <div class="bg-rose-600 px-8 py-4">
                <h3 class="text-white font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Data Diagnosa
                </h3>
            </div>

            <form action="/consult" method="post" class="p-8">

                <!-- Personal Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700 mb-1">Nama Pemilik
                            (Opsional)</label>
                        <input type="text" name="name" id="name"
                            class="w-full rounded-lg border-slate-300 focus:border-rose-500 focus:ring-rose-500 shadow-sm transition-colors"
                            placeholder="Contoh: Budi Santoso">
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-slate-700 mb-1">Umur Tanaman
                            (Bulan)</label>
                        <input type="text" name="age" id="age"
                            class="w-full rounded-lg border-slate-300 focus:border-rose-500 focus:ring-rose-500 shadow-sm transition-colors"
                            placeholder="Contoh: 3 bulan">
                    </div>
                </div>

                <hr class="border-slate-100 mb-8">

                <!-- Symptoms -->
                <!-- Wizard Container -->
                <div x-data="consultationWizard()" class="min-h-[400px]">

                    <!-- Step Progress -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-rose-600"
                                x-text="step === 1 ? 'Langkah 1: Pilih Area Masalah' : 'Langkah 2: Identifikasi Gejala'"></span>
                            <span class="text-sm text-slate-500" x-text="step === 1 ? '1/2' : progress + '%'"></span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5">
                            <div class="bg-rose-600 h-2.5 rounded-full transition-all duration-500"
                                :style="'width: ' + (step === 1 ? '50%' : progress + '%')"></div>
                        </div>
                    </div>

                    <!-- STEP 1: Category Selection -->
                    <div x-show="step === 1" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform -translate-x-4"
                        x-transition:enter-end="opacity-100 transform translate-x-0">
                        <h4 class="text-xl font-bold text-slate-800 mb-4">Di bagian mana masalah terlihat?</h4>
                        <p class="text-slate-500 mb-6">Pilih satu atau lebih area tanaman yang menunjukkan gejala tidak
                            normal.</p>

                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                            <template x-for="category in categories" :key="category">
                                <label class="cursor-pointer relative">
                                    <input type="checkbox" :value="category" x-model="selectedCategories"
                                        class="peer sr-only">
                                    <div
                                        class="p-4 rounded-xl border-2 border-slate-200 hover:border-rose-300 peer-checked:border-rose-500 peer-checked:bg-rose-50 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                                        <div
                                            class="w-10 h-10 rounded-full bg-slate-100 peer-checked:bg-rose-100 flex items-center justify-center text-xl">
                                            <span x-text="getCategoryIcon(category)"></span>
                                        </div>
                                        <span class="font-medium text-slate-700 peer-checked:text-rose-700"
                                            x-text="category"></span>
                                    </div>
                                    <div
                                        class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity text-rose-500">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </label>
                            </template>
                        </div>

                        <div class="flex justify-end">
                            <button type="button" @click="startDiagnosis()" :disabled="selectedCategories.length === 0"
                                class="disabled:opacity-50 disabled:cursor-not-allowed bg-rose-600 hover:bg-rose-700 text-white py-3 px-8 rounded-xl font-medium shadow-lg shadow-rose-200 transition-all transform hover:-translate-y-0.5">
                                Lanjut ke Pertanyaan
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Sequential Questions -->
                    <div x-show="step === 2" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform translate-x-4"
                        x-transition:enter-end="opacity-100 transform translate-x-0">

                        <!-- Question Card -->
                        <div x-show="currentQuestion"
                            class="bg-white border border-slate-100 rounded-2xl shadow-sm p-6 mb-8 text-center min-h-[300px] flex flex-col justify-center items-center relative overflow-hidden">
                            <!-- Background Pattern -->
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-400 to-amber-500">
                            </div>

                            <span
                                class="inline-block px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-medium mb-4"
                                x-text="currentQuestion?.category + ' (' + currentQuestion?.code + ')' "></span>

                            <h3 class="text-2xl font-bold text-slate-800 mb-6 max-w-2xl leading-relaxed"
                                x-text="currentQuestion?.name"></h3>

                            <p class="text-slate-500 mb-8">Seberapa yakin Anda melihat gejala ini?</p>

                            <!-- Confidence Options -->
                            <div class="flex flex-wrap justify-center gap-3">
                                <template x-for="opt in options" :key="opt.val">
                                    <button type="button" @click="answer(opt.val)"
                                        class="px-5 py-3 rounded-xl border-2 transition-all font-medium flex flex-col items-center min-w-[100px]"
                                        :class="hasAnswered(currentQuestion?.code) === opt.val ? 
                                            'border-rose-500 bg-rose-50 text-rose-700 ring-2 ring-rose-200' : 
                                            'border-slate-200 hover:border-rose-300 text-slate-600 hover:bg-slate-50'">
                                        <span class="text-lg mb-1" x-text="opt.emoji"></span>
                                        <span class="text-sm" x-text="opt.label"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <!-- Hidden Inputs for Form Submission -->
                        <template x-for="(conf, code) in answers" :key="code">
                            <input type="hidden" :name="'symptoms[' + code + ']'" :value="conf">
                        </template>

                        <!-- Navigation -->
                        <div class="flex justify-between items-center">
                            <button type="button" @click="prevQuestion()"
                                class="text-slate-500 hover:text-rose-600 font-medium px-4 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Sebelumnya
                            </button>

                            <div class="text-sm text-slate-400 font-medium">
                                <span x-text="currentIndex + 1"></span> dari <span
                                    x-text="filteredSymptoms.length"></span> Gejala
                            </div>

                            <button x-show="currentIndex === filteredSymptoms.length - 1" type="submit"
                                class="bg-rose-600 hover:bg-rose-700 text-white py-3 px-8 rounded-xl font-medium shadow-lg shadow-rose-200 transition-all transform hover:-translate-y-0.5 flex items-center">
                                Lihat Hasil Diagnosa
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                </svg>
                            </button>

                            <button x-show="currentIndex < filteredSymptoms.length - 1" type="button"
                                @click="nextQuestion()"
                                class="bg-slate-800 hover:bg-slate-900 text-white py-3 px-8 rounded-xl font-medium shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center">
                                Selanjutnya
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pt-8 border-t border-slate-100 mt-8" x-show="step === 1">
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-slate-400">* Pastikan data yang diisi sesuai dengan kondisi di lapangan.
                        </p>
                        <button type="button" onclick="window.history.back()"
                            class="bg-white py-3 px-6 border border-slate-300 rounded-xl shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">
                            Batal
                        </button>
                    </div>
                </div>

                <script>
                    const allSymptoms = {{ symptoms | tojson }};

                    function consultationWizard() {
                        return {
                            step: 1,
                            categories: ['Daun', 'Batang', 'Buah', 'Bunga', 'Akar', 'Umum'],
                            selectedCategories: [],
                            filteredSymptoms: [],
                            currentIndex: 0,
                            answers: {}, // Stores: { 'G01': 0.8, 'G02': 0.0 }

                            get currentQuestion() {
                                return this.filteredSymptoms[this.currentIndex];
                            },

                            get progress() {
                                if (this.filteredSymptoms.length === 0) return 0;
                                return Math.round(((this.currentIndex + 1) / this.filteredSymptoms.length) * 100);
                            },

                            options: [
                                { val: 0.0, label: 'Tidak', emoji: 'âŒ' },
                                { val: 0.2, label: 'Ragu', emoji: 'ðŸ¤”' },
                                { val: 0.6, label: 'Mungkin', emoji: 'ðŸ‘€' },
                                { val: 0.8, label: 'Yakin', emoji: 'âœ…' },
                                { val: 1.0, label: 'Sangat', emoji: 'ðŸ’¯' }
                            ],

                            getCategoryIcon(cat) {
                                const icons = {
                                    'Daun': 'ðŸŒ¿',
                                    'Batang': 'ðŸªµ',
                                    'Buah': 'ðŸ¥­',
                                    'Bunga': 'ðŸŒ¸',
                                    'Akar': 'ðŸª±',
                                    'Umum': 'ðŸ¦ '
                                };
                                return icons[cat] || 'ðŸŒ±';
                            },

                            startDiagnosis() {
                                if (this.selectedCategories.length === 0) return;

                                // Filter symptoms based on selected categories
                                this.filteredSymptoms = allSymptoms.filter(s =>
                                    this.selectedCategories.includes(s.category) || !s.category
                                );

                                if (this.filteredSymptoms.length === 0) {
                                    alert("Tidak ada gejala ditemukan untuk kategori ini.");
                                    return;
                                }

                                this.step = 2;
                                this.currentIndex = 0;
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            },

                            answer(confidence) {
                                const code = this.currentQuestion.code;
                                this.answers[code] = confidence;

                                // Auto advance after a short delay
                                setTimeout(() => {
                                    if (this.currentIndex < this.filteredSymptoms.length - 1) {
                                        this.nextQuestion();
                                    }
                                }, 200);
                            },

                            hasAnswered(code) {
                                return this.answers[code];
                            },

                            nextQuestion() {
                                if (this.currentIndex < this.filteredSymptoms.length - 1) {
                                    this.currentIndex++;
                                }
                            },

                            prevQuestion() {
                                if (this.currentIndex > 0) {
                                    this.currentIndex--;
                                } else {
                                    this.step = 1;
                                }
                            }
                        }
                    }
                </script>
            </form>
        </div>
    </div>
</div>
{% endblock %}